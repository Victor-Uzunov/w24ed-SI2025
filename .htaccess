# Enable rewrite engine
RewriteEngine On

# Prevent directory listing
Options -Indexes -MultiViews

# Set default character set
AddDefaultCharset UTF-8

# Protect against XSS, clickjacking and other vulnerabilities
Header set X-Content-Type-Options "nosniff"
Header set X-Frame-Options "DENY"
Header set X-XSS-Protection "1; mode=block"
Header set Referrer-Policy "same-origin"
Header set Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; connect-src 'self'"
Header set Strict-Transport-Security "max-age=31536000; includeSubDomains" env=HTTPS

# Remove server signature
ServerSignature Off

# Protect sensitive files
<FilesMatch "^(\.htaccess|\.gitignore|composer\.(json|lock)|schema\.sql|package\.json|package-lock\.json|README\.md)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Protect source and config directories
<FilesMatch "^(src|config|tests)/.*$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Allow access to API endpoints
<FilesMatch "^api/.*\.php$">
    Order Allow,Deny
    Allow from all
</FilesMatch>

# Block access to hidden files and directories
<FilesMatch "^\.">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Block access to backup and source files
<FilesMatch "~$|\.bak$|\.swp$|\.git">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# Prevent script execution in uploads directory if it exists
<IfModule mod_php7.c>
    php_flag engine off
</IfModule>

# PHP error handling
php_flag display_errors off
php_value error_reporting E_ALL
php_value error_log logs/php_errors.log

# Enable compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# Enable caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType text/javascript "access plus 1 year"
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType application/json "access plus 0 seconds"
    ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# Prevent access to logs
<Files "*.log">
    Order Allow,Deny
    Deny from all
</Files>

# Custom error pages
ErrorDocument 400 /error.php
ErrorDocument 401 /error.php
ErrorDocument 403 /error.php
ErrorDocument 404 /error.php
ErrorDocument 500 /error.php

# Force HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# API routing
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^api/([^/]+)/?$ api/$1.php [L,QSA] 